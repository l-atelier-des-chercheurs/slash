import{h as x,n as v,s as $}from"../build.js";import{P as O}from"./PublicationModule-D1KMDpcH.js";import"./CaptionCreditsPage-DdRviFVp.js";class w{constructor(t){this._values=t}toString(){return`Vector(${this._values.join(", ")})`}get length(){return this._values.length}dot(t){if(t instanceof w&&this.length===t.length)return this._values.map((i,s)=>i*t._values[s]).reduce((i,s)=>i+s);throw Error("The param `vector` must instance of Vector")}get(t){return this._values[t]}}class f{constructor(t){this._values=t}static zeros(t){return new f(new Array(t[0]).fill(null).map(()=>new Array(t[1]).fill(0)))}valueOf(){return JSON.parse(JSON.stringify(this._values))}toString(){return"Matrix ( "+this._values.map(t=>t.join(" ")).join(", ")+" )"}rows(){return this._values.length}cols(){return this._values[0].length}rowVector(t){return new w(this._values[t].slice(0))}colVector(t){let i=new Array(this.rows()).fill(0);return this._values.forEach((s,a)=>{i[a]=s[t]}),new w(i)}dot(t){if(t instanceof w&&this.cols()===t.length)return new w(new Array(t.length).fill(null).map((i,s)=>this.rowVector(s).dot(t)));if(t instanceof f&&this.cols()===t.rows()){let i=t.cols(),s=t.rows(),a=f.zeros([s,i]),r;for(let o=0;o<i;o++){r=this.dot(t.colVector(o));for(let n=0;n<s;n++)a._values[n][o]=r.get(n)}return a}throw Error("expected a Vector or Matrix but got "+typeof t)}get(t,i){return this._values[t][i]}T(){return new f(new Array(this.cols()).fill(null).map((t,i)=>new Array(this.rows()).fill(0).map((s,a)=>this.get(a,i))))}}const z={br:0,bm:1,bl:2,l:3,tl:4,tm:5,tr:6,r:7},A={tl:0,tm:1,tr:2,r:3,br:4,bm:5,bl:6,l:7},H={br:0,bm:0,bl:2,l:2,tl:4,tm:4,tr:6,r:6},P={l:1,r:1},T={tm:1,bm:1},N={tr:1,bl:1,r:1,l:1};function E(e){return e*Math.PI/180}function M(e){return e*180/Math.PI}function k({x:e,y:t,width:i,height:s,rotation:a},r){let o=a*Math.PI/180,n=i/2*r,d=s/2*r,h=new f([[Math.cos(o),Math.sin(o)],[-Math.sin(o),Math.cos(o)]]),p=new f([[-n,d],[0,d],[n,d],[n,0],[n,-d],[0,-d],[-n,-d],[-n,0]]);return h.dot(p.T()).T().valueOf().map(u=>({x:u[0]+n+e*r,y:-(u[1]-d)+t*r}))}function R(e,t){if(e.rotation===0)return{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height,width:e.width,height:e.height};let i=k(e,t),s=[],a=[];i.forEach(h=>{s.push(h.x),a.push(h.y)}),s=s.sort((h,p)=>h-p),a=a.sort((h,p)=>h-p);let r=s[0],o=s[s.length-1],n=a[0],d=a[a.length-1];return{left:r,right:o,top:n,bottom:d,width:o-r,height:d-n}}function B({type:e,x:t,y:i,dis:s,pressAngle:a,startAngle:r}){let o,n,d=M(Math.atan2(i,t)),h=E(a+d-r);return N[e]?(n=Math.cos(h)*s,o=Math.sin(h)*s):(n=Math.sin(h)*s,o=Math.cos(h)*s),{w:o,h:n}}const D=["nw","n","ne","e","se","s","sw","w"],I={tl:0,tm:1,tr:2,r:3,br:4,bm:5,bl:6,l:7};function F(e,t){let s=(I[e]+Math.floor(t/45))%8;return D[s]}const L={name:"ddr",props:{value:{default:function(){return{x:0,y:0,width:100,height:100,rotation:0}},type:Object},handlerSize:{type:Number,default:11},active:{default:!0,type:Boolean},resizeHandler:{default:function(){return["tl","tm","tr","r","br","bm","bl","l"]},type:Array},resizable:{default:!0,type:Boolean},rotatable:{default:!0,type:Boolean},draggable:{default:!0,type:Boolean},acceptRatio:{default:!1,type:Boolean},minWidth:{type:Number,default:1},minHeight:{type:Number,default:1},maxWidth:{type:Number,default:1e8},maxHeight:{type:Number,default:1e8},parent:{type:Boolean,default:!1},beforeActive:{type:Function,default:()=>!1},id:[Number,String],renderContent:Function,grid:{type:Array,default:()=>[1,1]},stop:{default:!0,type:Boolean},prevent:{default:!0,type:Boolean},zoom:{default:1,type:Number},axis:{type:String,default:"xy"}},data(){return{transform:Object.assign({},this.value),currentRatio:1,isInitialRatio:!1,isDragging:!1,isResizing:!1,isRotating:!1,isReadyToDrag:!1,isReadyToResize:!1,isReadyToRotate:!1}},created(){this.localeTransform={...this.transform}},watch:{value(e){this.transform={...e}}},computed:{rotateHandler(){let e=Math.ceil(this.handlerSize/this.zoom)+"px";return`width:${e};height:${e};top:-25px;margin-left:${-Math.floor(this.handlerSize/2)}px`},style(){let e=this.transform;return`left:${e.x}px;top:${e.y}px;width:${e.width}px;height:${e.height}px;transform:rotate(${e.rotation}deg)`}},methods:{handleDefaultEvent(e){this.stop&&e.stopPropagation(),this.prevent&&e.preventDefault()},getNewHandler(e){let t=F(e,this.transform.rotation),{handlerSize:i}=this,s={},a=-Math.floor(i/2)+"px";switch(e){case"tl":s={top:a,left:a};break;case"tm":s={top:a,"margin-left":a};break;case"tr":s={right:a,top:a};break;case"r":s={right:a,"margin-top":a};break;case"br":s={bottom:a,right:a};break;case"bm":s={"margin-left":a,bottom:a};break;case"bl":s={left:a,bottom:a};break;case"l":s={"margin-top":a,left:a};break}let r={cursor:t+"-resize",width:Math.ceil(i/this.zoom)+"px",height:Math.ceil(i/this.zoom)+"px",...s};return Object.keys(r).map(o=>`${o}:${r[o]}`).join(";")},emitChange(){this.$emit("input",{...this.transform})},handleMouseDown(e){if(!this.active&&!this.beforeActive(this.id))return;this.handleDefaultEvent(e);let t=e.touches?e.touches[0]:e,{clientX:i,clientY:s}=t;this._lastX=i,this._lastY=s,this._activeTarget=e.target,this._parentRect=this.$refs.wrapper.parentNode.getBoundingClientRect(),this._resizeHandler=e.target.dataset.resizetype,this.localeTransform={...this.transform},this.lastTransform={...this.transform},document.addEventListener("mousemove",this.handleMouseMove,!1),document.addEventListener("touchmove",this.handleMouseMove,!1),document.addEventListener("touchend",this.handleMouseUp,!1),document.addEventListener("mouseup",this.handleMouseUp,!1),e.target.dataset.type==="rotate"?(this._handlerType="rotate",this.isReadyToRotate=!0,this.handleRotateStart(e),this.$emit("rotatestart",e,this.transform)):this._activeTarget.dataset.resizetype?(this._handlerType="resize",this.isReadyToResize=!0,this.handleResizeStart(e),this.$emit("resizestart",e,this.transform)):(this._handlerType="drag",this.isReadyToDrag=!0,this.draggable&&this.$emit("dragstart",e,this.transform))},handleMouseMove(e){this.handleDefaultEvent(e);let{clientX:t,clientY:i}=e.touches?e.touches[0]:e;this.isReadyToDrag=!1,this.isReadyToResize=!1,this.isReadyToRotate=!1,this._deltaX=t-this._lastX,this._deltaY=i-this._lastY,this._lastX=t,this._lastY=i,this._handlerType==="resize"?(this.isResizing=!0,this.handleResizeMove(e),this.$emit("resize",e,this.transform)):this._handlerType==="drag"&&this.draggable?(this.isDragging=!0,this.doMove(e),this.$emit("drag",e,this.transform)):this._handlerType==="rotate"&&(this.isRotating=!0,this.handleRotateMove(e),this.$emit("rotate",e,this.transform)),this.emitChange()},doMove(){let[e,t]=this.grid,i=this._deltaX/this.zoom,s=this._deltaY/this.zoom,a=this.localeTransform.x=Math.round(this.localeTransform.x+i),r=this.localeTransform.y=Math.round(this.localeTransform.y+s),o={...this.transform};this.axis.includes("x")&&(a>o.x?o.x=a-a%e:a<o.x&&(o.x=a-(a%e-e))),this.axis.includes("y")&&(r>o.y?o.y=r-r%t:r<o.y&&(o.y=r-(r%t-t))),this.resetTranslate(o)},resetTranslate(e){if(!this.parent){this.transform=e;return}let t=R(e,this.zoom),i=0,s=0;t.left<0&&(i=t.left),t.right>this._parentRect.width&&(i=t.right-this._parentRect.width),t.top<0&&(s=t.top),t.bottom>this._parentRect.height&&(s=t.bottom-this._parentRect.height),e.x-=i,e.y-=s,this.transform=e},resetTransform(e){let t=R(e,this.zoom);this.allowTransform(t)?this.lastTransform=e:e=this.lastTransform,this.transform=e},allowTransform(e){return this.parent?e.left>=0&&e.right<=this._parentRect.width&&e.top>=0&&e.bottom<=this._parentRect.height:!0},handleMouseUp(e){this.handleDefaultEvent(e),document.removeEventListener("mousemove",this.handleMouseMove,!1),document.removeEventListener("mouseup",this.handleMouseUp,!1),document.removeEventListener("touchmove",this.handleMouseMove,!1),document.removeEventListener("touchend",this.handleMouseUp,!1);let t={drag:"draggable",resize:"resizable",rotate:"rotatable"};this.isInitialRatio=this.isDragging=this.isResizing=this.isRotating=!1,this.isReadyToDrag=this.isReadyToResize=this.isReadyToRotate=!1,this[t[this._handlerType]]&&this.$emit(this._handlerType+"end",e,this.transform)},handleResizeStart(e){let t=this._resizeHandler,i=this.transform,s=k(i,this.zoom),a,r=s[z[t]],o=s[H[t]],{clientX:n,clientY:d}=e.touches?e.touches[0]:e,h=s[A[t]],p=n-h.x,u=d-h.y,b=n-o.x-p,y=d-o.y-u,_=i.width,g=i.height;N[t]?a=M(Math.atan2(_,P[t]?g/2:g)):a=M(Math.atan2(g,T[t]?_/2:_));let c=M(Math.atan2(y,b));this._resizeOpt={matrix:s,rect:i,type:t,opposite:r,opp2:o,pressAngle:a,startAngle:c,offsetX:p,offsetY:u}},handleResizeMove(e){let{clientX:t,clientY:i}=e.touches?e.touches[0]:e,{opposite:s,opp2:a,type:r,pressAngle:o,startAngle:n,offsetX:d,offsetY:h}=this._resizeOpt,p=t-a.x-d,u=i-a.y-h,b=Math.hypot(u,p),y=e.shiftKey||this.acceptRatio,[_,g]=this.grid;!this.isInitialRatio&&y&&(this.currentRatio=this.transform.width/this.transform.height,this.isInitialRatio=!0),y||(this.isInitialRatio=!1);let{w:c,h:m}=B({type:r,dis:b,x:p,y:u,startAngle:n,pressAngle:o}),l={...this.localeTransform};this.isInitialRatio&&(P[r]?m=c/this.currentRatio:c=m*this.currentRatio),c/=this.zoom,m/=this.zoom,c=Math.min(Math.max(Math.round(c),this.minWidth),this.maxWidth),m=Math.min(Math.max(Math.round(m),this.minHeight),this.maxHeight),P[r]&&!y?l.width=c:(T[r]&&!y||(l.width=c),l.height=m),l.width%_>0&&(l.width>this.localeTransform.width?l.width=l.width-l.width%_:l.width=l.width-(l.width%_-_)),l.height%g>0&&(l.height>this.localeTransform.height?l.height=l.height-l.height%g:l.height=l.height-(l.height%g-g));let C=k(l,this.zoom)[z[r]],S=-(C.x-s.x)/this.zoom,X=-(C.y-s.y)/this.zoom;l.x=Math.round(l.x+S),l.y=Math.round(l.y+X),this.resetTransform(l)},handleRotateStart(e){let{clientX:t,clientY:i}=e.touches?e.touches[0]:e,s=this.$refs.wrapper.getBoundingClientRect(),a=s.left+s.width/2,r=s.top+s.height/2,o=180/Math.PI*Math.atan2(i-r,t-a),n=this.transform.rotation;this._rotateOpt={cx:a,cy:r,startAngle:o,rotation:n}},handleRotateMove(e){let{cx:t,cy:i,startAngle:s,rotation:a}=this._rotateOpt,{clientX:r,clientY:o}=e.touches?e.touches[0]:e,n=r-t,d=o-i,p=180/Math.PI*Math.atan2(d,n)-s,u=a+p;u=u%360,u=u<0?u+360:u,u=this.roundRotate(u);let b={...this.transform};b.rotation=Math.floor(u),this.resetTransform(b)},roundRotate(e){return e>355||e<5?0:e>85&&e<95?90:e>175&&e<185?180:e>265&&e<275?270:e},getClassNames(){const e=["yoyoo-ddr"];return this.active&&e.push("active"),this.isDragging&&e.push("ddr-dragging"),this.isResizing&&e.push("ddr-resizing"),this.isRotating&&e.push("ddr-rotating"),this.isReadyToDrag&&e.push("ddr-ready-drag"),this.isReadyToResize&&e.push("ddr-ready-resize"),this.isReadyToRotate&&e.push("ddr-ready-rotate"),e}},render(){return x("div",{ref:"wrapper",style:this.style,class:this.getClassNames(),on:{touchstart:this.handleMouseDown,mousedown:this.handleMouseDown}},[this.renderContent?this.renderContent(this):this.$slots.default,this.resizable&&x("div",{class:"resize-handler-wrapper"},[this.resizeHandler.map(e=>x("span",{attrs:{"data-resizetype":e},key:e,style:this.getNewHandler(e),class:`resize-handler ${e}`}))]),this.rotatable&&x("span",{style:this.rotateHandler,attrs:{"data-type":"rotate"},class:"rotate-handler"})])}},Y=null,j=null;var q=v(L,Y,j,!1,null,null);const J=q.exports,U={name:"app",props:{context:String,publimodule:Object,can_edit:Boolean,magnification:Number,gridstep:Number,scale:Number,module_being_edited:String,is_active:Boolean},components:{DDR:J,PublicationModule:O},data(){return{transform:{x:0,y:0,width:300,height:300,rotation:0},text_overflows:!1,component_key:1,aspect_ratio:!0,content_is_edited:!1}},created(){this.setTransformFromPubli(),this.setNewComponentKey()},mounted(){this.$eventHub.$on(`module.panTo.${this.module_meta_filename}`,this.panTo),this.$eventHub.$on(`module.enable_edit.${this.module_meta_filename}`,this.setActive)},beforeDestroy(){this.$eventHub.$off(`module.panTo.${this.module_meta_filename}`,this.panTo),this.$eventHub.$off(`module.enable_edit.${this.module_meta_filename}`,this.setActive)},watch:{transform:{handler(){var e;((e=this.first_media)==null?void 0:e.$type)==="text"&&this.detectOverflowText()},deep:!0},publimodule:{handler(){this.setTransformFromPubli()&&this.setNewComponentKey()},deep:!0},magnification(){this.setTransformFromPubli()&&this.setNewComponentKey()},is_active(){var e;this.is_active?this.first_media.$type!=="text"&&this.$emit("update:module_being_edited",this.publimodule.$path):(this.contentIsNotEdited(),(e=this.first_media)!=null&&e.$type&&["pdf","embed","url","audio","video"].includes(this.first_media.$type)&&this.setNewComponentKey())},"first_media.$content":{handler(){var e;((e=this.first_media)==null?void 0:e.$type)==="text"&&this.detectOverflowText()}}},computed:{first_media(){return this.firstMedia(this.publimodule)},module_meta_filename(){return this.publimodule.$path.split("/").at(-1)},grid(){return[this.gridstep,this.gridstep]},module_z_index(){return`
        z-index: ${this.publimodule.z_index?this.publimodule.z_index:0}
      `},on_click_action(){var e,t,i,s;return((e=this.publimodule.on_click)==null?void 0:e.type)==="page"&&((t=this.publimodule.on_click)!=null&&t.page_id)?{type:"page",page_id:this.publimodule.on_click.page_id}:((i=this.publimodule.on_click)==null?void 0:i.type)==="url"&&((s=this.publimodule.on_click)!=null&&s.url)?{type:"url",url:this.publimodule.on_click.url}:!1},scaled_border_radius(){if(!this.publimodule.border_radius)return;const e=this.turnCMtoPX(this.publimodule.border_radius)/(this.turnCMtoPX(this.publimodule.width)/100),t=this.turnCMtoPX(this.publimodule.border_radius)/(this.turnCMtoPX(this.publimodule.height)/100);return{x:e,y:t}},module_styles(){return{"--set-margins":(this.turnCMtoPX(this.publimodule.margins)||0)+"px","--set-opacity":this.publimodule.opacity||1,"--set-borderRadius":(this.turnCMtoPX(this.publimodule.border_radius)||0)+"px","--set-dropShadow":this.publimodule.drop_shadow,"--set-blur":(this.turnCMtoPX(this.publimodule.blur)||0)+"px","--set-backgroundColor":this.publimodule.background_color||"transparent","--set-outlineColor":this.publimodule.outline_color||"black","--set-outlineWidth":(this.turnCMtoPX(this.publimodule.outline_width)||0)+"px"}}},methods:{setNewComponentKey(){this.component_key=new Date().getTime()},setTransformFromPubli(){let e=!1;return Object.keys(this.transform).map(t=>{if(typeof this.publimodule[t]=="number")if(["x","y","width","height"].includes(t)){const i=this.turnCMtoPX(this.publimodule[t]);this.transform[t]!==i&&(this.transform[t]=i,e=!0)}else t==="rotation"&&this.transform[t]!==this.publimodule[t]&&(this.transform[t]=this.publimodule[t],e=!0)}),e},detectOverflowText(){const e=this.transform.height,t=this.$el.querySelector(".ql-editor").offsetHeight;this.text_overflows=t>e},async setHeightToTextBloc(){const e=this.turnPXtoCM(this.$el.querySelector(".ql-editor").offsetHeight+2);await this.updateModuleMeta({new_meta:{height:e}})},turnCMtoPX(e){return e?this.roundToDec(e*this.magnification):!1},turnPXtoCM(e){return this.roundToDec(e/this.magnification)},contentIsEdited(e){this.$eventHub.$emit("module.text_editing_enabled",e),this.content_is_edited=!0},contentIsNotEdited(){this.$eventHub.$emit("module.text_editing_disabled"),this.$emit("update:module_being_edited",void 0),this.content_is_edited=!1},dragStart(){},onDrag(e){},dragEnd(e,t){if(JSON.stringify(t)===JSON.stringify(this.transform)||this.turnPXtoCM(t.x)===this.turnPXtoCM(this.transform.x)&&this.turnPXtoCM(t.y)===this.turnPXtoCM(this.transform.y))return!1;this.updateTransform(t),e.stopPropagation()},resizeStart(e,t){return e.target.classList.contains("br")||e.target.classList.contains("bl")||e.target.classList.contains("tl")||e.target.classList.contains("tr")?this.aspect_ratio=!0:this.aspect_ratio=!1},resizeEnd(e,t){if(JSON.stringify(t)===JSON.stringify(this.transform))return!1;this.updateTransform(t),e.stopPropagation()},rotateEnd(e,t){if(JSON.stringify(t)===JSON.stringify(this.transform))return!1;this.updateTransform(t),e.stopPropagation()},onClickAction(){var e,t;((e=this.on_click_action)==null?void 0:e.type)==="page"?this.$eventHub.$emit("publication.togglePage",this.on_click_action.page_id):((t=this.on_click_action)==null?void 0:t.type)==="url"&&window.open(this.on_click_action.url,"_blank")},async updateTransform(e){let t=JSON.parse(JSON.stringify(e));Object.keys(t).map(i=>{t[i]!==this.transform[i]?["x","y","width","height"].includes(i)?(t[i]=this.turnPXtoCM(t[i]),this.transform[i]=this.turnCMtoPX(t[i])):this.transform[i]=this.turnCMtoPX(this.turnPXtoCM(t[i])):delete t[i]}),await this.updateModuleMeta({new_meta:t})},panTo(){this.$eventHub.$emit("panzoom.panTo",{x:this.transform.x,y:this.transform.y})},setActive(e){if(this.is_active)return!1;if(this.content_is_edited)return e.stopPropagation();!this.can_edit||this.is_active||this.publimodule.locked!==!0&&this.$eventHub.$emit("module.setActive",this.publimodule.$path)},async dblClick(){var e;if(this.is_active&&this.first_media)if(this.first_media.$type==="text")this.editText();else{const t=(e=this.first_media.$infos)==null?void 0:e.ratio,i=this.publimodule.width*t;await this.updateModuleMeta({new_meta:{height:i}})}},editText(){const e=this.publimodule.$path.substring(this.publimodule.$path.lastIndexOf("/")+1);this.$eventHub.$emit(`module.enable_edit.${e}`)},async lock(){const e={locked:!0};await this.updateModuleMeta({new_meta:e}),this.$eventHub.$emit("module.setActive",!1)},async unlock(){const e={locked:!1};await this.updateModuleMeta({new_meta:e}),setTimeout(()=>{this.setActive()},100)},async updateModuleMeta({new_meta:e}){await this.$api.updateMeta({path:this.publimodule.$path,new_meta:e}).catch(t=>{throw this.$alertify.delay(4e3).error(t),t})},onDuplicateModule(e){const t=this.publimodule.$path.substring(0,this.publimodule.$path.lastIndexOf("/")+1)+e;setTimeout(()=>{this.$eventHub.$emit("module.setActive",t)},100)}}};var V=function(){var t=this,i=t._self._c;return i("DDR",{key:t.component_key,staticClass:"_moveableItem",class:{"is--locked":t.publimodule.locked===!0,"is--editable":t.can_edit,"is--active":t.can_edit&&t.is_active,"is--beingEdited":t.content_is_edited},style:t.module_z_index,attrs:{active:t.can_edit&&t.is_active&&t.publimodule.locked!==!0&&t.content_is_edited!==!0,value:t.transform,parent:!1,acceptRatio:t.aspect_ratio,handlerSize:18,grid:t.grid,id:t.publimodule.$path,zoom:t.scale},on:{dragstart:t.dragStart,drag:t.onDrag,dragend:t.dragEnd,resizestart:t.resizeStart,resizeend:t.resizeEnd,rotateend:t.rotateEnd}},[i("span",{staticClass:"_activator panzoom-exclude",on:{mousedown:t.setActive,dblclick:t.dblClick}},[i("PublicationModule",{staticClass:"_moveableItem--content",style:t.module_styles,attrs:{publimodule:t.publimodule,border_radius:t.scaled_border_radius,context:t.context,page_template:"page_by_page",number_of_max_medias:1,magnification:t.magnification,can_edit:t.can_edit&&t.is_active,module_being_edited:t.module_being_edited},on:{"update:module_being_edited":function(s){return t.$emit("update:module_being_edited",s)},duplicate:t.onDuplicateModule,contentIsEdited:t.contentIsEdited,contentIsNotEdited:t.contentIsNotEdited}}),t.can_edit&&t.text_overflows?i("div",{staticClass:"_textOverflowNotice"},[i("button",{staticClass:"u-button u-button_icon u-button_red u-button_small",attrs:{type:"button"},on:{click:t.setHeightToTextBloc}},[i("b-icon",{attrs:{icon:"text-paragraph"}})],1)]):t._e()],1),i("div",{staticClass:"_bottomLeftButton"},[t.can_edit?[t.publimodule.locked===!0?i("button",{staticClass:"u-button u-button_orange u-button_icon u-button_small u-colorBlack",attrs:{type:"button"},on:{click:function(s){return s.stopPropagation(),t.unlock()},touchstart:function(s){return s.stopPropagation(),t.unlock()}}},[i("b-icon",{attrs:{icon:"lock"}})],1):t._e(),t.can_edit&&t.is_active&&!t.content_is_edited&&(!t.publimodule.locked||t.publimodule.locked===!1)?i("button",{staticClass:"u-button u-button_orange u-button_icon u-button_small u-colorBlack",attrs:{type:"button"},on:{click:function(s){return s.stopPropagation(),t.lock()},touchstart:function(s){return s.stopPropagation(),t.unlock()}}},[i("b-icon",{attrs:{icon:"unlock"}})],1):t._e()]:t._e(),t.on_click_action?i("button",{staticClass:"u-button u-button_orange u-button_small u-colorBlack",attrs:{type:"button"},on:{click:function(s){return s.stopPropagation(),t.onClickAction()},touchstart:function(s){return s.stopPropagation(),t.onClickAction()}}},[i("b-icon",{attrs:{icon:"link"}}),t.on_click_action.type==="page"&&t.on_click_action.page_id?[t._v(" "+t._s(t.$t("page"))+" ")]:t.on_click_action.type==="url"&&t.on_click_action.url?[t._v(" www ")]:t._e()],2):t._e()],2),t.on_click_action&&!t.can_edit?i("button",{staticClass:"_clickZone",attrs:{type:"button",title:t.on_click_action.type==="page"?t.$t("navigate_to_page"):t.$t("open_webpage")},on:{click:function(s){return t.onClickAction()}}}):t._e()])},W=[],Z=v(U,V,W,!1,null,"54883962");const K=Z.exports,Q={props:{context:String,page_modules:Array,page_width:Number,page_height:Number,layout_mode:{type:String,default:"print"},page_color:String,hide_pagination:Boolean,zoom:{type:Number,default:1},scale:{type:Number,default:1},show_grid:{type:Boolean,default:!1},snap_to_grid:{type:Boolean,default:!1},grid_z_index:{type:String,default:"under"},gridstep_in_mm:Number,margins:Object,page_number:Number,pagination:[Boolean,Object],active_module:[Boolean,Object],page_is_left:Boolean,can_edit:Boolean},components:{MoveableItem:K},data(){return{module_being_edited:void 0}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{l_margins(){return Object.keys(this.margins).length===0||this.margins.left===0&&this.margins.right===0&&this.margins.top===0&&this.margins.bottom===0?!1:this.page_is_left===!0?{left:this.margins.right,right:this.margins.left,top:this.margins.top,bottom:this.margins.bottom}:this.margins},gridstep(){return this.gridstep_in_mm?this.magnify(this.gridstep_in_mm):0},magnification(){return this.layout_mode==="screen"?1:this.$root.page_magnification},page_styles(){const e={};return this.page_width&&this.page_height&&(e["--page-width"]=`${this.magnify(this.page_width)}px`,e["--page-height"]=`${this.magnify(this.page_height)}px`),e["--zoom"]=this.zoom,e["--page-color"]=this.page_color||"#fff",e},page_number_corrected(){return this.page_number-this.pagination.pagination_start_on_page+1},pagination_styles(){const e={};return this.page_is_left===!0?e["--pagination-left"]=`${this.magnify(this.pagination.right)}px`:e["--pagination-right"]=`${this.magnify(this.pagination.right)}px`,e["--pagination-bottom"]=`${this.magnify(this.pagination.bottom)}px`,e}},methods:{magnify(e){return e*this.magnification}}};var G=function(){var t=this,i=t._self._c;return i("div",{staticClass:"_singlePage",class:{"is--preview":t.context==="preview","is--editable":t.can_edit}},[i("div",{staticClass:"_pagecontainer",style:t.page_styles},[i("div",{staticClass:"_pagecontent"},[t.can_edit&&t.show_grid?i("svg",{staticClass:"_grid",attrs:{"data-position":t.grid_z_index,width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg"}},[i("defs",[i("pattern",{attrs:{id:"gridSmall",width:t.gridstep,height:t.gridstep,patternUnits:"userSpaceOnUse"}},[i("path",{attrs:{d:`M ${t.gridstep} 0 L 0 0 0 ${t.gridstep}`,fill:"none",stroke:"var(--c-gridlines)",strokeWidth:"1"}})]),i("pattern",{attrs:{id:"grid",width:t.gridstep*5,height:t.gridstep*5,patternUnits:"userSpaceOnUse"}},[i("rect",{attrs:{width:t.gridstep*5,height:t.gridstep*5,fill:"url(#gridSmall)"}}),i("path",{attrs:{d:`M ${t.gridstep*5} 0 L 0 0 0 ${t.gridstep*5}`,fill:"none",stroke:"var(--c-gridfiveslines)",strokeWidth:"1"}})])]),i("rect",{attrs:{width:"100%",height:"100%",fill:"url(#grid)"}})]):t._e(),t._l(t.page_modules,function(s){return i("MoveableItem",{key:s.$path,staticClass:"_item",attrs:{context:t.context,publimodule:s,magnification:t.magnification,gridstep:t.show_grid&&t.snap_to_grid?t.gridstep:1,module_being_edited:t.module_being_edited,scale:t.scale,can_edit:t.can_edit,is_active:t.active_module.$path===s.$path},on:{"update:module_being_edited":function(a){t.module_being_edited=a}}})}),t.can_edit&&t.l_margins?i("svg",{staticClass:"_margins",attrs:{width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg",fill:"transparent"}},[i("rect",{attrs:{x:t.magnify(t.l_margins.left),y:t.magnify(t.l_margins.top),width:t.magnify(t.page_width-t.l_margins.left-t.l_margins.right),height:t.magnify(t.page_height-t.l_margins.top-t.l_margins.bottom)}})]):t._e(),t.pagination&&!t.hide_pagination&&t.page_number_corrected>0?i("div",{staticClass:"_pagination",style:t.pagination_styles},[t._v(" "+t._s(t.page_number_corrected)+" ")]):t._e(),t.can_edit?i("svg",{staticClass:"_pageBorders",attrs:{width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg",fill:"transparent"}},[i("rect",{attrs:{x:"0",y:"0",width:t.magnify(t.page_width),height:t.magnify(t.page_height),stroke:"black"}})]):t._e()],2)])])},tt=[],et=v(Q,G,tt,!1,null,"7cd9603d");const it=et.exports,st={props:{publication:Object,is_serversidepreview:Boolean},components:{SinglePage:it},data(){return{display_mode:"print",page_zoom:100,night_mode:!1}},created(){this.$eventHub.$on("publication.togglePage",this.togglePage)},async mounted(){var e;this.publication.layout_mode==="screen"?document.body.style=`
          --page-width: ${this.publication.page_width}px;
          --page-height: ${this.publication.page_height}px;
        `:this.publication.layout_mode==="print"&&(document.body.style=`
          --page-width: ${this.publication.page_width}mm;
          --page-height: calc(${this.publication.page_height}mm - 0mm);
        `),document.addEventListener("keydown",this.keyPressed),(((e=this.$route.query)==null?void 0:e.display)==="slides"||window.app_infos.page_is_standalone_html)&&(this.display_mode="slides"),this.display_mode==="slides"&&(this.fitZoomToPage(),window.addEventListener("resize",()=>{this.fitZoomToPage()}))},beforeDestroy(){this.$eventHub.$off("publication.togglePage",this.togglePage),document.removeEventListener("keydown",this.keyPressed)},watch:{},computed:{page_dimensions_to_px(){return this.publication.layout_mode==="print"?{width:this.publication.page_width*3.7952,height:this.publication.page_height*3.7952}:{width:this.publication.page_width,height:this.publication.page_height}},pagination(){return this.setPaginationFromPublication(this.publication)},pages_style(){return{"--page-zoom":this.page_zoom/100}},slides_current_page_or_spread_index(){var e;return(e=this.$route.query)!=null&&e.page?+this.$route.query.page:1},slide_current_page(){return this.pages?this.pages[this.slides_current_page_or_spread_index-1]:!1},slide_current_spread(){return this.spreads?this.spreads[this.slides_current_page_or_spread_index-1]:!1},pages_to_show(){var t;const e=(t=this.$route.query)==null?void 0:t.page;if(e&&e.includes("-")){const[i,s]=e.split("-");return this.pages.slice(i-1,s)}else if(e&&!e.includes("-"))return this.pages.slice(+e-1,+e);return this.pages},has_multiple_pages(){return this.is_spread?this.spreads.length>1:this.pages.length>1},modules(){return this.publication.$files||[]},pages(){return this.publication.pages?this.publication.pages:[]},is_spread(){return this.publication.page_spreads===!0},spreads(){return this.is_spread?this.makeSpread({pages:this.pages}):!1},spreads_to_show(){var t;const e=(t=this.$route.query)==null?void 0:t.page;if(e&&e.includes("-")){const[i,s]=e.split("-");return this.spreads.slice(i-1,s)}else if(e)return this.spreads.slice(+e-1,+e);return this.spreads}},methods:{fitZoomToPage(){let t=this.page_dimensions_to_px.width;this.is_spread&&(t*=2);let i=window.innerWidth/(t+70),s=window.innerHeight/(this.page_dimensions_to_px.height+70);this.page_zoom=Math.min(i,s)*100},keyPressed(e){if(!(this.$root.modal_is_opened||e.target.tagName.toLowerCase()==="select"||e.target.tagName.toLowerCase()==="input"||e.target.tagName.toLowerCase()==="textarea"||e.target.className.includes("ql-editor")||e.target.hasAttribute("contenteditable"))&&this.display_mode==="slides")switch(e.key){case"w":case"z":case"ArrowLeft":this.slides_current_page_or_spread_index>1&&this.updatePageQuery({prop:"page",val:this.slides_current_page_or_spread_index-1});break;case"s":case"ArrowRight":this.slides_current_page_or_spread_index<(this.is_spread?this.spreads.length:this.pages.length)&&this.updatePageQuery({prop:"page",val:this.slides_current_page_or_spread_index+1});break;case"p":this.page_zoom+=6;break;case"m":this.page_zoom-=6;break;case"r":this.fitZoomToPage();break;case"f":this.$emit("toggleFs");break;case"n":this.night_mode=!this.night_mode;break}},togglePage(e){const t=this.pages.findIndex(i=>i.id===e);t!==-1?this.updatePageQuery({prop:"page",val:t+1}):this.$alertify.error(this.$t("page_not_found"))},getCorrectPageNumber(e){return this.pages.findIndex(i=>i.id===e)}}};var at=function(){var t=this,i=t._self._c;return i("div",{staticClass:"_pageSlides",class:{"is--slides":t.display_mode==="slides","is--serversidepreview":t.is_serversidepreview,"is--nightmode":t.night_mode}},[i("div",{staticClass:"_pages",style:t.pages_style},[t.is_spread?[t.display_mode!=="slides"?t._l(t.spreads_to_show,function(s,a){return i("div",{key:a,staticClass:"_spread"},t._l(s,function(r,o){return i("div",{key:r.id?r.id:o,staticClass:"_spread--page"},[r?[i("SinglePage",{attrs:{context:"full",page_modules:t.getModulesForPage({modules:t.modules,page_id:r.id}),page_color:r.page_color,layout_mode:t.publication.layout_mode,hide_pagination:r.hide_pagination===!0,page_number:t.getCorrectPageNumber(r.id),pagination:t.pagination,can_edit:!1}})]:i("div",{staticClass:"_noPage"})],2)}),0)}):[i("transition",{attrs:{name:"fade_fast",mode:"out-in"}},[t.slide_current_spread?i("div",{key:"spread-"+t.slides_current_page_or_spread_index,staticClass:"_spread"},t._l(t.slide_current_spread,function(s,a){return i("div",{key:s.id?s.id:a,staticClass:"_spread--page"},[s?[i("SinglePage",{attrs:{context:"full",page_modules:t.getModulesForPage({modules:t.modules,page_id:s.id}),page_color:s.page_color,layout_mode:t.publication.layout_mode,hide_pagination:s.hide_pagination===!0,page_number:t.getCorrectPageNumber(s.id),pagination:t.pagination,can_edit:!1}})]:i("div",{staticClass:"_noPage"})],2)}),0):t._e()])]]:[t.display_mode!=="slides"?t._l(t.pages_to_show,function(s){return i("div",{key:"page-"+s.id,staticClass:"_page"},[i("SinglePage",{attrs:{context:"full",page_modules:t.getModulesForPage({modules:t.modules,page_id:s.id}),page_color:s.page_color,layout_mode:t.publication.layout_mode,hide_pagination:s.hide_pagination===!0,page_number:t.getCorrectPageNumber(s.id),pagination:t.pagination,can_edit:!1}})],1)}):[i("transition",{attrs:{name:"fade_fast",mode:"in-out"}},[t.slide_current_page?i("div",{key:"page-"+t.slide_current_page.id,staticClass:"_page"},[i("SinglePage",{attrs:{context:"full",page_modules:t.getModulesForPage({modules:t.modules,page_id:t.slide_current_page.id}),page_color:t.slide_current_page.page_color,layout_mode:t.publication.layout_mode,hide_pagination:t.slide_current_page.hide_pagination===!0,page_number:t.getCorrectPageNumber(t.slide_current_page.id),pagination:t.pagination,can_edit:!1}})],1):t._e()])]]],2),t.display_mode==="slides"&&t.has_multiple_pages?i("div",{staticClass:"_navBtns"},[i("span",[i("button",{staticClass:"u-button u-button_transparent u-button_small",attrs:{type:"button",disabled:t.slides_current_page_or_spread_index<=1},on:{click:function(s){return t.updatePageQuery({prop:"page",val:t.slides_current_page_or_spread_index-1})}}},[i("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 168 168"}},[i("path",{attrs:{d:"M87.46,49.46,73.39,64.77a65.3,65.3,0,0,1-6.15,6.15A47.8,47.8,0,0,1,61,75.29H131.6V91.14H61A39.1,39.1,0,0,1,67,95.51q2.81,2.46,6.36,6.15L87.46,117,74.48,128,34.17,83.21,74.48,38.39Z"}})])])]),i("span",{staticClass:"_pageInd"},[i("b",[i("transition",{attrs:{name:"pagechange",mode:"out-in"}},[i("select",{key:t.slides_current_page_or_spread_index,domProps:{value:t.slides_current_page_or_spread_index},on:{change:function(s){return t.updatePageQuery({prop:"page",val:s.target.value})}}},t._l(t.is_spread?t.spreads.length:t.pages.length,function(s,a){return i("option",{key:a,domProps:{value:a+1,textContent:t._s(a+1)}})}),0)]),t._l(t.is_spread?t.spreads.length:t.pages.length,function(s,a){return i("div",{key:a,attrs:{"v-text":a}})})],2),t._v(" / "+t._s(t.is_spread?t.spreads.length:t.pages.length))]),i("span",[i("button",{staticClass:"u-button u-button_transparent u-button_small",attrs:{type:"button",disabled:t.slides_current_page_or_spread_index>=(t.is_spread?t.spreads.length:t.pages.length)},on:{click:function(s){return t.updatePageQuery({prop:"page",val:t.slides_current_page_or_spread_index+1})}}},[i("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 168 168"}},[i("path",{attrs:{d:"M78.31,117l14.07-15.31a65.3,65.3,0,0,1,6.15-6.15,47.52,47.52,0,0,1,6.29-4.37H34.17V75.29h70.65a39.1,39.1,0,0,1-6.08-4.37q-2.8-2.46-6.36-6.15L78.31,49.46l13-11.07L131.6,83.21,91.29,128Z"}})])])])]):t._e()])},rt=[],ot=v(st,at,rt,!1,null,"b8ae7cba");const nt=ot.exports,lt={props:{publication:Object,is_serversidepreview:Boolean},components:{PageSlides:nt},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{},methods:{async toggleFs(){this.is_fullscreen?this.closeFs():this.openFs()},async openFs(){await $.request(this.$refs.fsContainer),this.is_fullscreen=!0,$.onchange(()=>{$.isFullscreen||(this.is_fullscreen=!1)})},async closeFs(){await $.exit(),this.is_fullscreen=!1}}};var dt=function(){var t=this,i=t._self._c;return i("div",[i("PageSlides",{attrs:{publication:t.publication,is_serversidepreview:t.is_serversidepreview},on:{toggleFs:t.toggleFs}})],1)},ht=[],ut=v(lt,dt,ht,!1,null,"789239e7");const mt=ut.exports;export{mt as default};
