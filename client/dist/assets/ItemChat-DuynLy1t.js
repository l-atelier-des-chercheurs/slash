import{p as c,n as i,S as l}from"../build.js";c.addHook("afterSanitizeAttributes",s=>{"target"in s&&(s.setAttribute("target","_blank"),s.setAttribute("rel","noopener noreferrer")),!s.hasAttribute("target")&&(s.hasAttribute("xlink:href")||s.hasAttribute("href"))&&s.setAttribute("xlink:show","new")});const h={name:"Message",props:{message:{type:Object,required:!0},max_message_length:Number,can_contribute_to_chat:{type:Boolean,default:!1},can_edit_chat:{type:Boolean,default:!1}},data(){return{show_remove_modal:!1,show_edit_modal:!1}},methods:{async removeMessage(){await this.$api.updateMeta({path:this.message.$path,new_meta:{$content:"message_removed"}})}},computed:{message_content(){return this.message.$content==="message_removed"?`<i>${this.$t("message_has_been_removed")}</i>`:this.message.$content?c.sanitize(this.message.$content):"â€¦"},message_is_removed(){return this.message.$content==="message_removed"},formatted_date(){return this.message.$date_uploaded?new Date(this.message.$date_uploaded).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"}):""},message_author_path(){var s,t;if(((s=this.message.$authors)==null?void 0:s.length)>0)return(t=this.message.$authors)==null?void 0:t[0]},is_self(){return this.message_author_path&&this.connected_as?this.message_author_path===this.connected_as.$path:!1}}};var d=function(){var t=this,e=t._self._c;return e("div",{ref:`message-${t.message.$path}`,staticClass:"_message",class:{"is--self":t.is_self,"is--removed":t.message_is_removed}},[e("div",{staticClass:"_message--header"},[e("div",{staticClass:"_message--header--author"},[t.message_author_path?[e("AuthorTag",{key:t.message_author_path,attrs:{path:t.message_author_path,size:"small"}})]:e("span",{staticClass:"_message--header--author--anonymous"},[t._v(" "+t._s(t.$t("anonymous_user"))+" ")])],2),e("div",{staticClass:"_message--header--date"},[t._v(" "+t._s(t.formatted_date)+" "),!t.message_is_removed&&t.can_contribute_to_chat&&(t.is_self||t.can_edit_chat)?[e("div",[e("button",{staticClass:"u-buttonLink",attrs:{type:"button",title:t.$t("edit")},on:{click:function(a){t.show_edit_modal=!0}}},[e("b-icon",{attrs:{icon:"pencil"}})],1)]),t.show_edit_modal?e("BaseModal2",{attrs:{title:t.$t("edit_this_message"),path:t.message.$path},on:{close:function(a){t.show_edit_modal=!1}}},[e("TitleField",{attrs:{label:t.$t("content"),field_name:"$content",content:t.message.$content,path:t.message.$path,input_type:"editor",mode:"edit_on_mounted",custom_formats:["bold","italic","link","emoji"],minlength:0,maxlength:t.max_message_length,can_edit:!0}})],1):t._e(),e("RemoveMenu",{attrs:{show_button_text:!1,modal_title:t.$t("remove_this_message")},on:{remove:t.removeMessage}})]:t._e()],2)]),e("div",{staticClass:"_message--content",domProps:{innerHTML:t._s(t.message_content)}})])},u=[],m=i(h,d,u,!1,null,"48085a85");const p=m.exports,g={data(){return{}},computed:{author_chat_read_index_media(){var t;return(t=this.connected_as)!=null&&t.$files?this.connected_as.$files.find(e=>e.$path.includes("chat-read-index")):null},author_chat_read_index(){var s;return((s=this.author_chat_read_index_media)==null?void 0:s.chat_read_indexes)||{}}},methods:{async updateAuthorLastReadMessage({chat_path:s,chat_read_index:t}){var e;if((e=this.connected_as)!=null&&e.$path)try{if(this.author_chat_read_index_media){const a=this.getIndexFromChatPath(s);(!a||a<t)&&await this.updateIndex(s,t)}else{const a={chat_read_indexes:{[s]:t},requested_slug:"chat-read-index"},{meta_filename:n}=await this.$api.uploadFile({path:this.connected_as.$path,additional_meta:a})}}catch(a){console.error("Failed to update chat read index:",a)}},getIndexFromChatPath(s){var t;return((t=this.author_chat_read_index)==null?void 0:t[s])||0},async updateIndex(s,t){if(!this.author_chat_read_index_media)return;const e=JSON.parse(JSON.stringify(this.author_chat_read_index));e[s]=t,await this.$api.updateMeta({path:this.author_chat_read_index_media.$path,new_meta:{chat_read_indexes:e}})}}},f={props:{path:String,current_linked_project_path:String},components:{SpaceProjectPicker:l},data(){return{selected_project_path:void 0}},created(){},async mounted(){},beforeDestroy(){},watch:{},computed:{},methods:{closeModal(){this.$emit("close")},onProjectSelected(s){this.selected_project_path=s},async linkProject(){debugger;await this.$api.updateMeta({path:this.path,new_meta:{linked_project_path:this.selected_project_path}}),this.$emit("close")}}};var $=function(){var t=this,e=t._self._c;return e("BaseModal2",{attrs:{title:"Projet en lien"},on:{close:t.closeModal},scopedSlots:t._u([{key:"footer",fn:function(){return[e("SaveCancelButtons",{attrs:{cancel_text:t.$t("cancel"),save_text:t.$t("save")},on:{save:t.linkProject,cancel:t.closeModal}})]},proxy:!0}])},[e("div",{staticClass:"_projectLinkModal"},[e("SpaceProjectPicker",{attrs:{path:t.current_linked_project_path},on:{newProjectSelected:t.onProjectSelected}}),t.selected_project_path?e("div",{staticClass:"u-spacingTop"},[e("div",{staticClass:"u-label"},[t._v(t._s(t.$t("path")))]),e("div",{staticClass:"u-instructions"},[t._v(t._s(t.selected_project_path))])]):t._e()],1)])},v=[],b=i(f,$,v,!1,null,"6630037f");const w=b.exports,C={props:{chat_slug:{type:String,required:!0}},components:{Message:p,ProjectLinkModal:w},mixins:[g],data(){return{chat:null,err_loading_chat:!1,is_loading:!0,new_message:"",max_messages_to_display:50,load_all_messages:!1,show_remove_modal:!1,show_project_link_modal:!1,pane_scroll_until_end:0,is_posting_message:!1,last_message_read_index:0,max_message_length:300,allow_send:!1}},created(){},async mounted(){await this.loadChat(),this.last_message_read_index=this.getIndexFromChatPath(this.chat.$path),this.is_loading=!1,this.unread_since_last_visit>this.max_messages_to_display&&(this.max_messages_to_display=this.unread_since_last_visit+10),this.$api.join({room:this.chat.$path}),this.pane_scroll_until_end<100&&this.updateAuthorReadCount(),setTimeout(()=>{this.scrollToUnread()},100),this.$eventHub.$on("file.created",this.newMessagePosted)},beforeDestroy(){this.$api.leave({room:this.chat.$path}),this.$eventHub.$off("file.created",this.newMessagePosted)},watch:{sorted_messages:{handler(){this.$nextTick(()=>{})},deep:!0},pane_scroll_until_end:{handler(){this.pane_scroll_until_end<100&&this.updateAuthorReadCount()}}},computed:{unread_since_last_visit(){return this.chat.$files_count-this.last_message_read_index},messages(){return!this.chat||!this.chat.$files?[]:this.chat.$files.filter(s=>s.hasOwnProperty("$content"))},sorted_messages(){let s=this.messages.slice().sort((t,e)=>+new Date(t.$date_uploaded)-+new Date(e.$date_uploaded));return s=s.map((t,e)=>(t._index=e,t)),this.load_all_messages||(s=s.slice(-this.max_messages_to_display)),s},messages_grouped_by_date(){return this.sorted_messages.reduce((s,t)=>{const e=new Date(t.$date_uploaded).toDateString();let a=s.find(n=>n.date===e);return a||(a={date:e,messages:[]},s.push(a)),a.messages.push(t),s},[])},can_edit_chat(){return this.canLoggedinEditFolder({folder:this.chat})},can_contribute_to_chat(){return this.chat?this.canLoggedinContributeToFolder({folder:this.chat}):!1}},methods:{onScroll(s){this.pane_scroll_until_end=s.target.scrollHeight-s.target.scrollTop-s.target.clientHeight},newMessagePosted({meta:s}){this.$nextTick(()=>{this.scrollToLatest("smooth"),this.updateAuthorReadCount()})},async updateAuthorReadCount(){await this.updateAuthorLastReadMessage({chat_path:this.chat.$path,chat_read_index:this.messages.length})},async loadChat(){const s=await this.$api.getFolder({path:"/chats/"+this.chat_slug}).catch(t=>{this.err_loading_chat=t.message||t.code});this.chat=s},closeChat(){this.$emit("close")},onProjectSelected(s){},async postMessage(){var n;if(!this.new_message)return;if(!this.allow_send){this.new_message.length>this.max_message_length&&this.$alertify.delay(4e3).error(this.$t("message_too_long",{max_length:this.max_message_length}));return}this.is_posting_message=!0;const s="message-"+ +new Date+".txt";let t={};(n=this.connected_as)!=null&&n.$path&&(t.$authors=[this.connected_as.$path]);const e=this.cleanUpString(this.new_message),{meta_filename:a}=await this.$api.uploadText({path:this.chat.$path,filename:s,additional_meta:t,content:e});this.chat.$path+""+a,this.is_posting_message=!1,this.new_message="",new Date().toISOString(),this.messages.length,this.last_message_read_index+=1,this.$nextTick(()=>{try{this.$refs.textInput.$children[0].editor.focus()}catch{}})},scrollToMessage(s){const t=this.$refs[`message-${s}`];t&&t.length>0&&t[0].$el.scrollIntoView({behavior:"smooth"})},scrollToLatest(s="smooth"){this.$refs.messages&&this.$refs.messages.scrollTo({top:this.$refs.messages.scrollHeight,behavior:s})},async scrollToUnread(){var s,t,e;return(s=this.$refs.unreadMessagesNotice)!=null&&s[0]?(e=(t=this.$refs.unreadMessagesNotice)==null?void 0:t[0])==null?void 0:e.scrollIntoView({behavior:"instant"}):this.scrollToLatest("instant")},openLinkedProject(){const s=this.createURLFromPath(this.chat.linked_project_path);this.$router.push(s)}}};var x=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_openedChat"},[t.is_loading?e("LoaderSpinner"):!t.chat&&t.err_loading_chat?e("div",{staticClass:"_error"},[t._v(" "+t._s(t.$t("error:"))+" "+t._s(t.err_loading_chat)+" ")]):[e("div",{key:"chat",staticClass:"_openedChat--header"},[e("div",{staticClass:"_openedChat--header--row"},[e("button",{staticClass:"u-button u-button_icon _backBtn",attrs:{type:"button"},on:{click:t.closeChat}},[e("b-icon",{attrs:{icon:"arrow-left-circle","aria-label":t.$t("back")}})],1),e("TitleField",{staticClass:"_openedChat--header--title",attrs:{field_name:"title",label:t.$t("title"),show_label:!1,content:t.chat.title,path:t.chat.$path,tag:"h3",required:!0,can_edit:t.can_edit_chat}}),t.can_edit_chat?e("DropDown",{staticClass:"_actions",attrs:{show_label:!1,right:!0}},[e("button",{staticClass:"u-buttonLink u-buttonLink_red",attrs:{type:"button"},on:{click:function(a){t.show_remove_modal=!0}}},[e("b-icon",{attrs:{icon:"trash"}}),t._v(" "+t._s(t.$t("remove"))+" ")],1)]):e("div")],1),t.show_remove_modal?e("RemoveMenu2",{attrs:{modal_title:t.$t("remove_chat",{name:t.chat.title}),success_notification:t.$t("chat_was_removed"),path:t.chat.$path},on:{removedSuccessfully:function(a){return t.$emit("close")},close:function(a){t.show_remove_modal=!1}}}):t._e(),e("div",{staticClass:"_openedChat--header--row"},[e("div",[e("div",{staticClass:"u-label"},[t._v(t._s(t.$t("linked_project")))])]),e("div",[t.chat.linked_project_path?e("div",{},[e("button",{staticClass:"u-button u-button_white u-button_small",attrs:{type:"button"},on:{click:t.openLinkedProject}},[e("b-icon",{attrs:{icon:"arrow-right-short"}}),t._v(" "+t._s(t.$t("open"))+" ")],1)]):e("div",{},[e("div",{staticClass:"u-instructions"},[t._v(t._s(t.$t("no_linked_project")))])])]),e("div",[e("EditBtn",{attrs:{label_position:"left",btn_type:t.chat.linked_project_path===0?"add":"edit",is_unfolded:t.chat.linked_project_path===0},on:{click:function(a){t.show_project_link_modal=!0}}}),t.show_project_link_modal?e("ProjectLinkModal",{attrs:{path:t.chat.$path,current_linked_project_path:t.chat.linked_project_path},on:{close:function(a){t.show_project_link_modal=!1}}}):t._e()],1),e("div")]),e("div",{staticClass:"_openedChat--header--row _adminsAndContributors"},[e("AdminsAndContributorsField",{attrs:{folder:t.chat,can_edit:t.can_edit_chat,custom_label:t.$t("participants"),admin_label:t.$t("referent"),admin_instructions:t.$t("chat_admin_instructions"),contrib_instructions:t.$t("chat_contrib_instructions")}}),e("div",{staticClass:"_status"},[e("StatusTag",{attrs:{status:t.chat.$status,status_options:["public","private"],path:t.chat.$path,can_edit:t.can_edit_chat}})],1)],1)],1),e("div",{ref:"messages",staticClass:"_openedChat--content",on:{scroll:t.onScroll}},[t.messages_grouped_by_date.length===0?e("div",{staticClass:"u-instructions _noMessages"},[t._v(" "+t._s(t.$t("no_messages_in_chat").toLowerCase())+" ")]):[t.messages.length>t.max_messages_to_display&&!t.load_all_messages?e("div",{staticClass:"_loadMoreMessages"},[e("button",{staticClass:"u-button u-button_red u-button_small",attrs:{type:"button"},on:{click:function(a){t.load_all_messages=!0}}},[t._v(" "+t._s(t.$t("load_older_messages"))+" ")])]):t._e(),t._l(t.messages_grouped_by_date,function(a){return[e("div",{key:a.date,staticClass:"_dayTitle"},[t._v(" "+t._s(t.formatDateToHuman(a.date))+" ")]),t._l(a.messages,function(n,o){var r,_;return[n._index===t.last_message_read_index?e("div",{ref:"unreadMessagesNotice",refInFor:!0,staticClass:"_unreadMessages"},[e("b-icon",{attrs:{icon:"arrow-down-short"}}),t._v(" "+t._s(t.$tc("new_messages",t.unread_since_last_visit,{count:t.unread_since_last_visit}).toLowerCase())+" "),e("b-icon",{attrs:{icon:"arrow-down-short"}})],1):t._e(),o>0&&((r=a.messages[o-1].$authors)==null?void 0:r[0])!==((_=n.$authors)==null?void 0:_[0])?e("div",{staticClass:"_changeAuthor"}):t._e(),e("Message",{key:n.$path,ref:`message-${n.$path}`,refInFor:!0,attrs:{message:n,max_message_length:t.max_message_length,can_edit_chat:t.can_edit_chat,can_contribute_to_chat:t.can_contribute_to_chat}})]})]}),e("div",{staticClass:"_message--footer"},[e("b-icon",{attrs:{icon:"check-lg"}})],1),e("div",{staticClass:"_scrollToEndBtn"},[e("transition",{attrs:{name:"scrollEndBtn"}},[t.pane_scroll_until_end>100?e("button",{staticClass:"u-button u-button_icon u-button_red",attrs:{type:"button"},on:{click:function(a){return t.scrollToLatest()}}},[e("b-icon",{attrs:{icon:"arrow-down"}})],1):t._e()])],1)]],2),e("div",{staticClass:"_openedChat--footer"},[t.connected_as?t.can_contribute_to_chat?[e("TextInput",{ref:"textInput",attrs:{content:t.new_message,autofocus:!0,input_type:"editor",placeholder:t.$t("write_a_message"),custom_formats:["bold","italic","link","emoji"],minlength:0,maxlength:t.max_message_length,intercept_enter:!0},on:{"update:content":function(a){t.new_message=a},toggleValidity:a=>t.allow_send=a,onEnter:t.postMessage},scopedSlots:t._u([{key:"suffix",fn:function(){return[t.new_message.length>0?e("button",{staticClass:"u-button u-button_bleumarine _sendBtn",attrs:{type:"button",disabled:t.is_posting_message||!t.allow_send},on:{click:t.postMessage}},[t.is_posting_message?e("b-icon",{attrs:{icon:"three-dots",animation:"cylon"}}):e("svg",{attrs:{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"}},[e("path",{attrs:{d:"M2 21L23 12L2 3V10L17 12L2 14V21Z",fill:"currentColor"}})])],1):t._e()]},proxy:!0}])})]:[e("div",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("not_allowed_to_post_messages"))+" ")])]:[e("div",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("you_must_login_to_contribute"))+" ")])]],2)]],2)},y=[],k=i(C,x,y,!1,null,"eabe05fd");const j=k.exports,M={props:{file:{type:Object,required:!0}},components:{OpenedChat:j},data(){return{chat_slug:null,is_loading:!0}},async mounted(){await this.findChat(),this.is_loading=!1},computed:{},methods:{async findChat(){const s=await this.$api.getFolders({path:"chats"});if(!s||!Array.isArray(s))return;const t=s.find(e=>e.linked_file_path===this.file.$path);t&&(this.chat_slug=t.$path.split("/").pop())},async createChat(){const s=await this.$api.createFolder({path:"chats",additional_meta:{$contributors:"everyone",linked_file_path:this.file.$path}});this.chat_slug=s}}};var L=function(){var t=this,e=t._self._c;return e("BaseModal2",{attrs:{title:t.$t("chats"),is_closable:!0,size:t.chat_slug?"large":void 0},on:{close:function(a){return t.$emit("close")}}},[t.is_loading?e("div",{staticClass:"_loader"},[e("LoaderSpinner")],1):t.chat_slug?e("div",{staticClass:"_chatWrapper"},[e("OpenedChat",{attrs:{chat_slug:t.chat_slug},on:{close:function(a){t.chat_slug=null}}})],1):e("div",[e("button",{staticClass:"u-button",attrs:{type:"button"},on:{click:t.createChat}},[e("b-icon",{attrs:{icon:"chat-left-text"}}),t._v(" "+t._s(t.$t("comment")||"Comment")+" ")],1)])])},S=[],T=i(M,L,S,!1,null,"4b3b2104");const A=T.exports;export{A as default};
